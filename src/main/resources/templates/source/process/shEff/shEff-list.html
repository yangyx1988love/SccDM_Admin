<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <title>废水无组织排放</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
    <link rel="stylesheet" th:href="@{/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/animate.min.css}">
</head>

<body>

<div class="page-loading">
    <div class="rubik-loader"></div>
</div>
<!--<div class="z-body animated fadeIn">-->
    <form class="layui-form layui-col-md12 we-search">
        <div class="layui-show" style="margin-left:30px;margin-top: 2px;margin-bottom: 2px">
            <div class="layui-input-inline">
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="year" name="year" placeholder="年份">
                </div>
            </div>
            <div class="layui-input-inline">
                <select id="cityCode" name="cityCode" lay-filter="cityCode">
                    <option value="">请选择实际城市</option>
                    <option th:each="city : ${citys}" th:value="${city.cityCode}" th:text="${city.cityName}">
                    </option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="countyId" name="countyId" lay-filter="countyId">
                    <option value="">请选择实际区县</option>
                    <option th:each="county : ${countys}" th:value="${county.countyId}" th:text="${county.countyName}">
                    </option>
                </select>
            </div>
            <button  id="selectshEff" type="button" class="layui-btn" lay-submit lay-filter="search" data-type="reload">
                <i class="layui-icon">&#xe615;</i></button>
        </div>
        <div class="layui-colla-content layui-show">
            <table class="layui-hide" id="shEff-tab"></table>
        </div>
    </form>
<!--</div>-->

<script th:src="@{/lib/jquery/jquery.min.js}"></script>
<script th:src="@{/lib/layui/layui.js}"></script>
<script th:src="@{/js/common.js}"></script>

<script type="text/html" id="toolbar">
    <shiro:hasPermission name="source:process:delete">
        <a class="layui-btn layui-btn-blue" lay-event="add"><i class="layui-icon layui-icon-add-circle"></i>新增</a>
    </shiro:hasPermission>
</script>
<script type="text/html" id="column-toolbar">
    <shiro:hasPermission name="source:process:delete">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    </shiro:hasPermission>
    <shiro:hasPermission name="source:process:delete">
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </shiro:hasPermission>
</script>
<script>
    layui.use(['table','form', 'element','laydate'], function () {
        var table = layui.table //表格
            ,form = layui.form //form表单
            ,element = layui.element
            , laydate = layui.laydate;
        //年选择器
        laydate.render({
            elem: '#year'
            ,type: 'year'
        });
        table.render({
            elem: '#shEff-tab'
            , url: '/source/process/shEff/list'
            , toolbar: '#toolbar'
            , cols: [
                [
                    {field: 'year', sort:true, title: '年份'}
                    , {field: 'cityName', title: '城市'}
                    , {field: 'countyName', title: '区县'}
                    , {field: 'companyName', title: '企业名称'}
                    , {field: 'sourceDiscrip', title: '基本信息描述'}
                    , {field: 'activity', title: '活动水平'}
                    , {field: 'activityNote', title: '活动水平备注'}
                    , {field: 'pm25Emission', title: 'PM2.5'}
                    , {field: 'pm10Emission', title: 'PM10'}
                    , {field: 'coEmission', title: 'CO'}
                    , {field: 'ocEmission', title: 'OC'}
                    , {field: 'bcEmission', title: 'BC'}
                    , {field: 'vocEmission', title: 'VOC'}
                    , {field: 'so2Emission', title: 'SO2'}
                    , {field: 'noxEmission', title: 'NOX'}
                    , {field: 'nh3Emission', title: 'NH3'}
                    , {title: '操作',width: "10%", fixed: 'right', align: 'center', toolbar: '#column-toolbar'}
                ]
            ]
            ,page: true   //开启分页
            ,limit:50   //默认十条数据一页
            ,limits:[50,100,200]  //数据分页条
        });
        // 行点击事件 重置密码
        table.on('tool', function (obj) {
            var data = obj.data;
            var event = obj.event;
            if (event === 'del') {
                del(obj);
            }
            if (event === 'edit') {
                edit(obj);
            }
        });
        // 工具条点击事件
        table.on('toolbar', function (obj) {
            var data = obj.data;
            var event = obj.event;
            if (event == 'add') {
                add(obj);
            }
        });
        function edit(obj) {
            var data = obj.data;
            var url = '/source/process/shEff/' + data.id;
            var content = ' <div class="layui-tab-item layui-show">' +
                '<iframe class="layui-iframe" src="' + url + '"></iframe></div>';
            parent.layui.element.tabAdd('lay-tab',{
                title:'编辑-废水无组织排放',
                content: content,
                id:'shEff-tab'
            });
            parent.layui.element.tabChange('lay-tab','shEff-tab');
        }
        function add(obj) {
            var url = '/source/process/shEff/add/';
            var content = ' <div class="layui-tab-item layui-show">' +
                '<iframe class="layui-iframe" src="' + url + '"></iframe></div>';
            parent.layui.element.tabAdd('lay-tab',{
                title:'编辑-废水无组织排放',
                content: content,
                id:'shEff-tab'
            });
            parent.layui.element.tabChange('lay-tab','shEff-tab');
        }
        function del(obj) {
            layer.confirm("确定删除吗?", {icon: 3, title: '提示'},
                function (index) {// 确定回调
                    var data = obj.data;
                    var id = data.id;
                    $.post('/source/process/shEff/' + id, {_method: "DELETE"}, function (data) {
                        layer.close(index);
                        handlerResult(data, deleteDone);
                    });
                }, function (index) {//取消回调
                    layer.close(index);
                }
            );
        }
        function deleteDone(data) {
            parent.layer.msg("删除成功", {icon: 6});
            table.reload('shEff-tabReload');
        }
        //监听提交 lay-filter="search"
        form.on('submit(search)', function(data){
            var formData = data.field;
            var countyId = formData.countyId,
                cityCode = formData.cityCode,
                year=formData.year
            //执行重载
            table.reload('shEff-tabReload',{
               where: {
                   cityCode:cityCode,
                    countyId: countyId,
                    year:year
                }
            });
            return false;//false：阻止表单跳转  true：表单跳转
        });
        //城市区县级联选择
        form.on('select(cityCode)',function(data){
            var cityCode=data.value;
            $.ajax({
                url: '/factoryAuth/seleCountry/' + cityCode,
                data: {cityCode: cityCode},//发送的参数
                type: "post",
                success: function (datas) {
                    $("select[name=countyId]").html('<option value="">请选择</option>'); //清空
                    if(datas.length>0){
                        $.each(datas, function(key, val) {
                            var option1 = $("<option>").val(val.countyId).text(val.countyName);
                            $("select[name=countyId]").append(option1);
                            form.render('select');
                        });
                    }else{
                        form.render('select');
                    }
                },
                error:function(){
                    //失败执行的方法
                    layer.msg("区县信息加载失败!", {icon: 6});
                }
            })
        });
    });

</script>

</body>

</html>