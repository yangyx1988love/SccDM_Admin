<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>堆场装卸扬尘源</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
    <link rel="stylesheet" th:href="@{/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/animate.min.css}">
</head>

<body>

<div class="page-loading">
    <div class="rubik-loader"></div>
</div>
<!--<div class="z-body animated fadeIn">-->
    <form class="layui-form layui-col-md12 we-search">
        <div class="layui-show" style="margin-left:30px;margin-top: 2px;margin-bottom: 2px">
            <div class="layui-input-inline">
                <select id="year" name="year">
                    <option value="">请选择</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                    <option value="2014">2014</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="countyCity" name="countyCity" lay-filter="countyCity">
                    <option value="">请选择实际城市</option>
                    <option th:each="city : ${citys}" th:value="${city.cityCode}" th:text="${city.cityName}">
                    </option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="countyId" name="countyId" lay-filter="countyId">
                    <option value="">请选择实际区县</option>
                    <option th:each="county : ${countys}" th:value="${county.countyId}" th:text="${county.countyName}">
                    </option>
                </select>
            </div>
            <button  id="selectdustLoad" type="button" class="layui-btn" lay-submit lay-filter="search" data-type="reload">
                <i class="layui-icon">&#xe615;</i></button>
        </div>
        <div class="layui-colla-content layui-show">
            <table class="layui-hide" id="dustLoadTable"></table>
        </div>
    </form>
<!--</div>-->

<script th:src="@{/lib/jquery/jquery.min.js}"></script>
<script th:src="@{/lib/layui/layui.js}"></script>
<script th:src="@{/js/common.js}"></script>
<script type="text/html" id="column-toolbar">
    <!--       <shiro:hasPermission name="role:update">-->
    <!--        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>-->
    <!--    </shiro:hasPermission>-->
    <shiro:hasPermission name="source:dust:delete">
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </shiro:hasPermission>
</script>
<script>
    layui.use(['table','form', 'element','upload'], function () {
        var table = layui.table //表格
            ,form = layui.form //form表单
            ,element = layui.element
            ,upload = layui.upload;
        table.render({
            elem: '#dustLoadTable'
            , url: '/source/dust/dustLoad/list'
            , page: true
            , toolbar: '#toolbar'
            , cols: [
                [
                    {field: 'year', title: '年份'}
                    , {field: 'countyName', title: '区县'}
                    , {field: 'companyName', title: '工厂名称'}
                    , {field: 'sccDescribe', title: 'SCC信息描述'}
                    , {field: 'pm25Emission', title: 'PM2.5'}
                    , {field: 'pm10Emission', title: 'PM10'}
                    , {field: 'coEmission', title: 'CO'}
                    , {field: 'ocEmission', title: 'OC'}
                    , {field: 'bcEmission', title: 'BC'}
                    , {field: 'vocEmission', title: 'VOC'}
                    , {field: 'so2Emission', title: 'SO2'}
                    , {field: 'noxEmission', title: 'NOX'}
                    , {field: 'nh3Emission', title: 'NH3'}
                    , {title: '操作', fixed: 'right', align: 'center', toolbar: '#column-toolbar'}
                ]
            ]
            ,page: true   //开启分页
            ,limit:50   //默认十条数据一页
            ,limits:[50,100,200]  //数据分页条
            ,id: 'dustLoadTableReload'
        });
        // 行点击事件 重置密码
        table.on('tool', function (obj) {
            var data = obj.data;
            var event = obj.event;
            if (event === 'del') {
                del(obj);
            }
            if (event === 'edit') {
                edit(data.id);
            }
        });
        // function edit(id) {
        //     layer.open({
        //         content: "/source/dust/dustLoad/" + id,
        //         title: "编辑-散煤",
        //         area: ['40%', '85%'],
        //         type: 2,
        //         maxmin: true,
        //         shadeClose: true,
        //         end: function () {
        //             table.reload('dustLoadTableReload');
        //         }
        //     });
        // }
        function del(obj) {
            layer.confirm("确定删除吗?", {icon: 3, title: '提示'},
                function (index) {// 确定回调
                    var id = obj.data.id;
                    $.post('/source/dust/dustLoad/' + id, {_method: "DELETE"}, function (data) {
                        layer.close(index);
                        handlerResult(data, deleteDone);
                    });
                }, function (index) {//取消回调
                    layer.close(index);
                }
            );
        }
        function deleteDone(data) {
            parent.layer.msg("删除成功", {icon: 6});
            table.reload('dustLoadTableReload');
        }
        //监听提交 lay-filter="search"
        form.on('submit(search)', function(data){
            var formData = data.field;
            var countyId = formData.countyId,
                year=formData.year
            //执行重载
            table.reload('dustLoadTableReload',{
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                , where: {
                    countyId: countyId,
                    year:year
                }
                , url: '/source/dust/dustLoad/reload'//后台做模糊搜索接口路径
                , method: 'GET'
            });
            return false;//false：阻止表单跳转  true：表单跳转
        });
        //城市区县级联选择
        form.on('select(countyCity)',function(data){
            var cityCode=data.value;
            $.ajax({
                url: '/factoryAuth/seleCountry/' + cityCode,
                data: {cityCode: cityCode},//发送的参数
                type: "post",
                success: function (datas) {
                    $("select[name=countyId]").html('<option value="">请选择</option>'); //清空
                    if(datas.length>0){
                        $.each(datas, function(key, val) {
                            var option1 = $("<option>").val(val.countyId).text(val.countyName);
                            $("select[name=countyId]").append(option1);
                            form.render('select');
                        });
                    }else{
                        form.render('select');
                    }
                },
                error:function(){
                    //失败执行的方法
                    layer.msg("区县信息加载失败!", {icon: 6});
                }
            })
        });
    });

</script>

</body>

</html>